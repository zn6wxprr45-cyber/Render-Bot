# -*- coding: utf-8 -*-

"""
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Ç–µ–ª–µ–≥—Ä–∞–º–º-–±–æ—Ç–∞ "–û–Ω–ª–∞–π–Ω-–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞"
–¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ—Å—Ç–∏–Ω—Å—É–ª—å—Ç–Ω—ã–º —Ç–∞–ª–∞–º–∏—á–µ—Å–∫–∏–º —Å–∏–Ω–¥—Ä–æ–º–æ–º.

*** –≠–¢–ê –í–ï–†–°–ò–Ø –ü–†–ï–î–ù–ê–ó–ù–ê–ß–ï–ù–ê –î–õ–Ø –†–ê–ë–û–¢–´ –ß–ï–†–ï–ó WEBHOOK (Render/Gunicorn) ***
"""

import logging
import os
import json
import datetime
import asyncio
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    ContextTypes,
    filters,
)
from telegram.constants import ParseMode
import firebase_admin
from firebase_admin import credentials, firestore, auth

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
appId = os.environ.get("CANVAS_APP_ID", 'default-app-id')

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
firebase_config_str = os.environ.get("FIREBASE_CONFIG", '{}')

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Firestore
db = None

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é (–Ω–∞ —Ä—É—Å—Å–∫–æ–º) ---
SURVEY_BTN = "–ü—Ä–æ–π—Ç–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ–ø—Ä–æ—Å"
INFO_BTN = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–µ"
EMERGENCY_BTN = "–°—Ä–æ—á–Ω–∞—è –ø–æ–º–æ—â—å"
FEEDBACK_BTN = "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
ILLNESS_BTN = "–û –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–∏"
CANCEL_BTN = "–û—Ç–º–µ–Ω–∞"

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler (–û–ø—Ä–æ—Å) ---
(
    Q1_PAIN_LEVEL,
    Q2_PAIN_TYPE,
    Q3_MEDICATION,
    Q4_SIDE_EFFECTS,
    Q5_COMMENTS,
) = range(5)

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler (–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å) ---
GET_FEEDBACK = range(5, 6)


def initialize_firebase():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase Admin SDK, –∏—Å–ø–æ–ª—å–∑—É—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
    """
    global db
    try:
        firebase_config = json.loads(firebase_config_str)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
        if firebase_config and firebase_config.get('type') == 'service_account':
             cred = credentials.Certificate(firebase_config)
        else:
             # –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ ApplicationDefault (–¥–ª—è —Å—Ä–µ–¥, –≥–¥–µ —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
             logger.warning("Firebase config –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–∞ 'service_account'. –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ApplicationDefault.")
             cred = credentials.ApplicationDefault()


        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        if not firebase_admin._apps:
            firebase_admin.initialize_app(cred)
            logger.info("Firebase Admin SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        else:
            logger.info("Firebase Admin SDK —É–∂–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

        db = firestore.client()
        logger.info(f"Firebase App ID: {appId}")
        logger.info("–ö–ª–∏–µ–Ω—Ç Firestore —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

    except json.JSONDecodeError:
        logger.error("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è FIREBASE_CONFIG. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è JSON-—Å—Ç—Ä–æ–∫–∞.")
        db = None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: {e}")
        db = None


async def get_user_id(update: Update) -> str | None:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Telegram User ID –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏.
    –≠—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ {userId} –≤ –ø—É—Ç–∏ Firestore.
    """
    if not update.effective_user:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id –∏–∑ update")
        return None
    return str(update.effective_user.id)


def get_main_menu_keyboard() -> ReplyKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é.
    """
    keyboard = [
        [KeyboardButton(SURVEY_BTN)],
        [KeyboardButton(ILLNESS_BTN), KeyboardButton(INFO_BTN)],
        [KeyboardButton(FEEDBACK_BTN), KeyboardButton(EMERGENCY_BTN)],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)


# --- –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç
    –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.
    """
    user = update.effective_user
    user_id = await get_user_id(update)
    chat_id = update.effective_chat.id

    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (ID: {user_id}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.")

    await update.message.reply_html(
        rf"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}!",
        reply_markup=get_main_menu_keyboard(),
    )
    await update.message.reply_text(
        "–Ø - –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏ –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ—Å—Ç–∏–Ω—Å—É–ª—å—Ç–Ω—ã–º —Ç–∞–ª–∞–º–∏—á–µ—Å–∫–∏–º —Å–∏–Ω–¥—Ä–æ–º–æ–º.\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –æ–ø—Ä–æ—Å –æ —Å–≤–æ–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ."
    )

    if db and user_id:
        try:
            # –ü—É—Ç—å –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_ref = db.collection(f"artifacts/{appId}/users/{user_id}").document("profile")
            user_data = {
                "telegram_id": user_id,
                "first_name": user.first_name,
                "last_name": user.last_name,
                "username": user.username,
                "last_seen": firestore.SERVER_TIMESTAMP,
            }
            # set(..., merge=True) –æ–±–Ω–æ–≤–∏—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç
            user_ref.set(user_data, merge=True)
            logger.info(f"–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è {user_id} –≤ Firestore: {e}")
            await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.")

    # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ run_polling) ---
    # –í —Ä–µ–∂–∏–º–µ Webhook (Render/Gunicorn) job_queue –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç.–∫. –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∂–∏–≤–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.
    # –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (Cron job).
    # –ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –∫–æ–¥ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ –≤ Webhook-–≤–µ—Ä—Å–∏–∏,
    # —Ç.–∫. –æ–Ω –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ Render.

    # if context.job_queue:
    #     job_name = f"daily_reminder_{chat_id}"
    #     current_jobs = context.job_queue.get_jobs_by_name(job_name)
    #     ...
    # return ConversationHandler.END
    return ConversationHandler.END


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ---

async def show_illness_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ª–∏—Å—Ç–æ–∫ –æ –±–æ–ª–µ–∑–Ω–∏.
    """
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {await get_user_id(update)} –∑–∞–ø—Ä–æ—Å–∏–ª '–û –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–∏'")
    text = (
        "‚ÑπÔ∏è **–û –ø–æ—Å—Ç–∏–Ω—Å—É–ª—å—Ç–Ω–æ–º —Ç–∞–ª–∞–º–∏—á–µ—Å–∫–æ–º —Å–∏–Ω–¥—Ä–æ–º–µ (—Å–∏–Ω–¥—Ä–æ–º –î–µ–∂–µ—Ä–∏–Ω–∞-–†—É—Å—Å–∏)**\n\n"
        "–≠—Ç–æ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ –±–æ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç —Ä–∞–∑–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –∏–Ω—Å—É–ª—å—Ç–∞, –ø–æ–≤—Ä–µ–¥–∏–≤—à–µ–≥–æ —Ç–∞–ª–∞–º—É—Å - —á–∞—Å—Ç—å –º–æ–∑–≥–∞, –æ—Ç–≤–µ—á–∞—é—â—É—é –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–µ–Ω—Å–æ—Ä–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n"
        "**–û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:**\n"
        "‚Ä¢ –ß–∞—Å—Ç–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è, –∂–≥—É—á–∞—è –∏–ª–∏ –Ω–æ—é—â–∞—è –±–æ–ª—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Ç–µ–ª–∞, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π –æ—á–∞–≥—É –∏–Ω—Å—É–ª—å—Ç–∞.\n"
        "‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è–º (–∞–ª–ª–æ–¥–∏–Ω–∏—è) –∏–ª–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º.\n"
        "‚Ä¢ –û—â—É—â–µ–Ω–∏–µ –æ–Ω–µ–º–µ–Ω–∏—è, –ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏—è.\n\n"
        "**–¢–µ—á–µ–Ω–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è:**\n"
        "–°–∏–º–ø—Ç–æ–º—ã –º–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –∫–∞–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏–Ω—Å—É–ª—å—Ç–∞, —Ç–∞–∫ –∏ —Å–ø—É—Å—Ç—è –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –º–µ—Å—è—Ü—ã. –ë–æ–ª—å –æ–±—ã—á–Ω–æ –Ω–æ—Å–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –ø–ª–æ—Ö–æ –ø–æ–¥–¥–∞–µ—Ç—Å—è –ª–µ—á–µ–Ω–∏—é –æ–±—ã—á–Ω—ã–º–∏ –∞–Ω–∞–ª—å–≥–µ—Ç–∏–∫–∞–º–∏.\n\n"
        "**–í–∞–∂–Ω–æ:**\n"
        "–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ —Ç–æ—á–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—É—Ä–æ–≤–µ–Ω—å –±–æ–ª–∏, –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã) –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ç–µ—Ä–∞–ø–∏–∏. "
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω—è–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ–ø—Ä–æ—Å–Ω–∏–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ."
    )
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)


async def show_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã.
    """
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {await get_user_id(update)} –∑–∞–ø—Ä–æ—Å–∏–ª '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–µ'")
    text = (
        "**–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –Ω–∞—à–µ–π –æ–Ω–ª–∞–π–Ω-–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏:**\n\n"
        "‚Ä¢ **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (—á–µ—Ä–µ–∑ –±–æ—Ç–∞):** –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ, 24/7.\n"
        "‚Ä¢ **–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–æ–º:** –í–∞—à–∏ –∞–Ω–∫–µ—Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º –≤ –±—É–¥–Ω–∏–µ –¥–Ω–∏ —Å 9:00 –¥–æ 17:00.\n"
        "‚Ä¢ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:** –í—Ä–∞—á —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ (–∏–ª–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å) –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è.\n\n"
        "‚ùóÔ∏è*–≠—Ç–æ—Ç –±–æ—Ç –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.*"
    )
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)


async def show_emergency(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–æ—á–Ω–æ–π –ø–æ–º–æ—â–∏.
    """
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {await get_user_id(update)} –∑–∞–ø—Ä–æ—Å–∏–ª '–°—Ä–æ—á–Ω–∞—è –ø–æ–º–æ—â—å'")
    text = (
        "üö® **–°–†–û–ß–ù–ê–Ø –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ü–û–ú–û–©–¨** üö®\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç **–ù–ï –Ø–í–õ–Ø–ï–¢–°–Ø** —Å–ª—É–∂–±–æ–π —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏.\n\n"
        "–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–æ —É–≥—Ä–æ–∂–∞—é—â–µ–µ –∂–∏–∑–Ω–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∏–º–ø—Ç–æ–º—ã –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—É–ª—å—Ç–∞, —Å–∏–ª—å–Ω–æ–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ, –ø–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è, –Ω–µ–≤—ã–Ω–æ—Å–∏–º–∞—è –±–æ–ª—å, –Ω–µ —Å–Ω–∏–º–∞—é—â–∞—è—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏):\n\n"
        "1. **–ù–ï–ú–ï–î–õ–ï–ù–ù–û** –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É **103** –∏–ª–∏ **112**.\n"
        "2. –°–æ–æ–±—â–∏—Ç–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É –æ —Å–≤–æ–∏—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö –∏ –æ —Ç–æ–º, —á—Ç–æ —É –≤–∞—Å –≤ –∞–Ω–∞–º–Ω–µ–∑–µ –∏–Ω—Å—É–ª—å—Ç.\n\n"
        "–ù–µ —Ç—Ä–∞—Ç—å—Ç–µ –≤—Ä–µ–º—è –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –±–æ—Ç–µ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏!"
    )
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)


# --- –õ–æ–≥–∏–∫–∞ –û–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (ConversationHandler) ---

async def feedback_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Å–±–æ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.
    """
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {await get_user_id(update)} –Ω–∞—á–∞–ª '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å'")
    await update.message.reply_text(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –æ—Ç–∑—ã–≤ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ú—ã –ø–µ—Ä–µ–¥–∞–¥–∏–º –µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n\n"
        "–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û—Ç–º–µ–Ω–∞'.",
        reply_markup=ReplyKeyboardMarkup([[CANCEL_BTN]], resize_keyboard=True),
    )
    return GET_FEEDBACK


async def receive_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü–æ–ª—É—á–∞–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥.
    """
    user_id = await get_user_id(update)
    feedback_text = update.message.text

    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤: {feedback_text[:50]}...")

    if db:
        try:
            feedback_data = {
                "user_id": user_id,
                "feedback_text": feedback_text,
                "timestamp": firestore.SERVER_TIMESTAMP,
            }
            # .add() —Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å –∞–≤—Ç–æ-ID
            db.collection(f"artifacts/{appId}/users/{user_id}/feedback").add(feedback_data)
            logger.info(f"–û—Ç–∑—ã–≤ –æ—Ç {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore.")

            await update.message.reply_text(
                "–°–ø–∞—Å–∏–±–æ! –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ.",
                reply_markup=get_main_menu_keyboard(),
            )
            return ConversationHandler.END

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ {user_id} –≤ Firestore: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –æ—Ç–∑—ã–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=get_main_menu_keyboard(),
            )
            return ConversationHandler.END
    else:
        logger.error("Firestore (db) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û—Ç–∑—ã–≤ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.")
        await update.message.reply_text(
            "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤.",
            reply_markup=get_main_menu_keyboard(),
        )
        return ConversationHandler.END


# --- –õ–æ–≥–∏–∫–∞ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –û–ø—Ä–æ—Å–∞ (ConversationHandler) ---

async def survey_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ–ø—Ä–æ—Å. (–í–æ–ø—Ä–æ—Å 1)
    """
    user_id = await get_user_id(update)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞—á–∞–ª –æ–ø—Ä–æ—Å.")

    # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    context.user_data["survey"] = {}

    keyboard = [
        ["0", "1", "2", "3", "4"],
        ["5", "6", "7", "8", "9", "10"],
        [CANCEL_BTN]
    ]
    await update.message.reply_text(
        "–ù–∞—á–∏–Ω–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ–ø—Ä–æ—Å.\n\n"
        "**–í–æ–ø—Ä–æ—Å 1/5:**\n"
        "–û—Ü–µ–Ω–∏—Ç–µ –≤–∞—à *–æ–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–æ–ª–∏* –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –ø–æ —à–∫–∞–ª–µ –æ—Ç 0 –¥–æ 10:\n"
        "(–≥–¥–µ 0 - –Ω–µ—Ç –±–æ–ª–∏, 10 - –Ω–µ–≤—ã–Ω–æ—Å–∏–º–∞—è –±–æ–ª—å)",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return Q1_PAIN_LEVEL


async def q1_pain_level(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 1. –ó–∞–¥–∞–µ—Ç –í–æ–ø—Ä–æ—Å 2.
    """
    answer = update.message.text
    if not answer.isdigit() or not (0 <= int(answer) <= 10):
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10.")
        return Q1_PAIN_LEVEL

    context.user_data["survey"]["pain_level"] = int(answer)
    logger.info(f"Q1 (Pain Level): {answer}")

    keyboard = [
        ["–ñ–≥—É—á–∞—è", "–ö–æ–ª—é—â–∞—è"],
        ["–ù–æ—é—â–∞—è", "–°—Ç—Ä–µ–ª—è—é—â–∞—è"],
        ["–î—Ä—É–≥–æ–µ (–æ–ø–∏—à—É)"],
        [CANCEL_BTN]
    ]
    await update.message.reply_text(
        "**–í–æ–ø—Ä–æ—Å 2/5:**\n"
        "–ö–∞–∫–æ–π *—Ö–∞—Ä–∞–∫—Ç–µ—Ä* –±–æ–ª–∏ –ø—Ä–µ–æ–±–ª–∞–¥–∞–ª?",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return Q2_PAIN_TYPE


async def q2_pain_type(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 2. –ó–∞–¥–∞–µ—Ç –í–æ–ø—Ä–æ—Å 3.
    """
    answer = update.message.text
    context.user_data["survey"]["pain_type"] = answer
    logger.info(f"Q2 (Pain Type): {answer}")

    await update.message.reply_text(
        "**–í–æ–ø—Ä–æ—Å 3/5:**\n"
        "–ö–∞–∫–∏–µ *–ø—Ä–µ–ø–∞—Ä–∞—Ç—ã* (–≤–∫–ª—é—á–∞—è –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–∏–µ) –∏ –≤ –∫–∞–∫–∏—Ö –¥–æ–∑–∏—Ä–æ–≤–∫–∞—Ö –≤—ã –ø—Ä–∏–Ω–∏–º–∞–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞?\n\n"
        "(–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–µ–≥–∞–±–∞–ª–∏–Ω 150–º–≥ —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º, –ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª 500–º–≥ –¥–Ω–µ–º')",
        reply_markup=ReplyKeyboardMarkup([[CANCEL_BTN]], resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return Q3_MEDICATION


async def q3_medication(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 3. –ó–∞–¥–∞–µ—Ç –í–æ–ø—Ä–æ—Å 4.
    """
    answer = update.message.text
    context.user_data["survey"]["medication"] = answer
    logger.info(f"Q3 (Medication): {answer}")

    keyboard = [
        ["–î–∞", "–ù–µ—Ç"],
        [CANCEL_BTN]
    ]
    await update.message.reply_text(
        "**–í–æ–ø—Ä–æ—Å 4/5:**\n"
        "–ó–∞–º–µ—Ç–∏–ª–∏ –ª–∏ –≤—ã –∫–∞–∫–∏–µ-–ª–∏–±–æ *–ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã* –æ—Ç –ª–µ—á–µ–Ω–∏—è? (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å, –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ, —Ç–æ—à–Ω–æ—Ç–∞)\n\n"
        "–ï—Å–ª–∏ –¥–∞, –æ–ø–∏—à–∏—Ç–µ –∏—Ö. –ï—Å–ª–∏ –Ω–µ—Ç, –Ω–∞–∂–º–∏—Ç–µ '–ù–µ—Ç'.",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return Q4_SIDE_EFFECTS


async def q4_side_effects(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 4. –ó–∞–¥–∞–µ—Ç –í–æ–ø—Ä–æ—Å 5.
    """
    answer = update.message.text
    context.user_data["survey"]["side_effects"] = answer
    logger.info(f"Q4 (Side Effects): {answer}")

    keyboard = [
        ["–í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ"],
        [CANCEL_BTN]
    ]
    await update.message.reply_text(
        "**–í–æ–ø—Ä–æ—Å 5/5:**\n"
        "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å *–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏* –∏–ª–∏ –∂–∞–ª–æ–±—ã? (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–±–æ–ª—å —É—Å–∏–ª–∏–ª–∞—Å—å –Ω–æ—á—å—é', '—Å–æ–Ω —Å—Ç–∞–ª –ª—É—á—à–µ')",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
        parse_mode=ParseMode.MARKDOWN
    )
    return Q5_COMMENTS


async def q5_comments_and_save(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ—Å—å –æ–ø—Ä–æ—Å –≤ Firestore. –ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥.
    """
    answer = update.message.text
    context.user_data["survey"]["comments"] = answer
    logger.info(f"Q5 (Comments): {answer}")

    user_id = await get_user_id(update)
    survey_data = context.user_data["survey"]

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è
    survey_data["timestamp"] = firestore.SERVER_TIMESTAMP
    survey_data["user_id"] = user_id

    if db:
        try:
            # .add() —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º ID –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'surveys'
            db.collection(f"artifacts/{appId}/users/{user_id}/surveys").add(survey_data)
            logger.info(f"–û–ø—Ä–æ—Å –¥–ª—è {user_id} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore.")

            await update.message.reply_text(
                "–°–ø–∞—Å–∏–±–æ! –í–∞—à –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω.\n"
                "–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
                reply_markup=get_main_menu_keyboard(),
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞ {user_id} –≤ Firestore: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –æ–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=get_main_menu_keyboard(),
            )
    else:
        logger.error("Firestore (db) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–ø—Ä–æ—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.")
        await update.message.reply_text(
            "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø—Ä–æ—Å.",
            reply_markup=get_main_menu_keyboard(),
        )

    # –û—á–∏—â–∞–µ–º user_data
    context.user_data.pop("survey", None)
    return ConversationHandler.END


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥ (–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å).
    """
    user = update.effective_user
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} –æ—Ç–º–µ–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é.")
    await update.message.reply_text(
        "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_menu_keyboard()
    )

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
    context.user_data.pop("survey", None)

    return ConversationHandler.END


# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø WEBHOOK ---

# –ó–¥–µ—Å—å –º—ã —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç application, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–µ–Ω Gunicorn
# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è application –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
application = None

def setup_application():
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç Application.
    """
    global application

    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    initialize_firebase()
    if not db:
        logger.critical("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firestore. –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω.")
        # –í–º–µ—Å—Ç–æ return –ª—É—á—à–µ –±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã Gunicorn –∑–Ω–∞–ª –æ–± –æ—à–∏–±–∫–µ
        raise RuntimeError("Firebase initialization failed.")

    # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
    BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
    if not BOT_TOKEN:
        logger.critical("–ù–µ –Ω–∞–π–¥–µ–Ω TELEGRAM_BOT_TOKEN. –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω.")
        raise RuntimeError("Missing TELEGRAM_BOT_TOKEN.")

    # 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(BOT_TOKEN).build()

    # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã (–¥–ª—è –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤) ---
    cancel_handler = CommandHandler("cancel", cancel)
    cancel_button_handler = MessageHandler(filters.Regex(f"^{CANCEL_BTN}$"), cancel)

    # --- –î–∏–∞–ª–æ–≥ –û–±—Ä–∞—Ç–Ω–æ–π –°–≤—è–∑–∏ ---
    feedback_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(f"^{FEEDBACK_BTN}$"), feedback_start)],
        states={
            GET_FEEDBACK: [MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.Regex(f"^{CANCEL_BTN}$"), receive_feedback)],
        },
        fallbacks=[cancel_handler, cancel_button_handler],
    )

    # --- –î–∏–∞–ª–æ–≥ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –û–ø—Ä–æ—Å–∞ ---
    survey_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(f"^{SURVEY_BTN}$"), survey_start)],
        states={
            Q1_PAIN_LEVEL: [MessageHandler(filters.Regex(r"^\d+$") & ~filters.COMMAND, q1_pain_level)],
            Q2_PAIN_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.Regex(f"^{CANCEL_BTN}$"), q2_pain_type)],
            Q3_MEDICATION: [MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.Regex(f"^{CANCEL_BTN}$"), q3_medication)],
            Q4_SIDE_EFFECTS: [MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.Regex(f"^{CANCEL_BTN}$"), q4_side_effects)],
            Q5_COMMENTS: [MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.Regex(f"^{CANCEL_BTN}$"), q5_comments_and_save)],
        },
        fallbacks=[cancel_handler, cancel_button_handler],
    )

    # 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(CommandHandler("start", start))

    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥–∏
    application.add_handler(survey_conv_handler)
    application.add_handler(feedback_conv_handler)

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫-–∫–æ–º–∞–Ω–¥
    application.add_handler(MessageHandler(filters.Regex(f"^{ILLNESS_BTN}$"), show_illness_info))
    application.add_handler(MessageHandler(filters.Regex(f"^{INFO_BTN}$"), show_info))
    application.add_handler(MessageHandler(filters.Regex(f"^{EMERGENCY_BTN}$"), show_emergency))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç)
    async def other_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
        await update.message.reply_text(
            "–Ø –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
            reply_markup=get_main_menu_keyboard()
        )
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, other_text))

    logger.info("Application handlers set up successfully.")
    return application

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Gunicorn
application = setup_application()


async def set_webhook_on_startup(app: Application):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Webhook –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è URL –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    –≠—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
    """
    WEBHOOK_URL = os.environ.get("WEBHOOK_URL")
    if not WEBHOOK_URL:
        logger.warning("WEBHOOK_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. Webhook –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        return

    # Render –∑–∞–ø—É—Å–∫–∞–µ—Ç Gunicorn –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º URL, –ø–æ—ç—Ç–æ–º—É –ø—É—Ç—å –Ω–µ –Ω—É–∂–µ–Ω.
    # –ï—Å–ª–∏ –±—ã –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ ngrok, –ø—É—Ç—å –º–æ–≥ –±—ã –±—ã—Ç—å /telegram.
    webhook_url = WEBHOOK_URL

    try:
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Webhook
        await app.bot.set_webhook(url=webhook_url)
        logger.info(f"Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ URL: {webhook_url}")
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Webhook: {e}")
        # –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏, –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–π—Ç–∏, –Ω–æ Gunicorn –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

# –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Webhook –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# Gunicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏ –Ω–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
# –ú—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å asyncio.run_coroutine_threadsafe –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞—Ç—å –µ–≥–æ
# –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, —á—Ç–æ —Å–ª–æ–∂–Ω–æ —Å Gunicorn.

# –ü–æ—Å–∫–æ–ª—å–∫—É `python-telegram-bot` –≤–µ—Ä—Å–∏–∏ 20.x –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
# –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Webhook –∏ Gunicorn, –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ.
# –í Gunicorn `application` –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ WSGI/ASGI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

# –ß—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å `set_webhook`, –Ω–∞–º –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥.
# –ú—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –∫–∞–∫ –∑–∞–¥–∞—á—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ Gunicorn.
# –ù–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ - —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–µ
# —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gunicorn, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.

import threading

def run_once_set_webhook():
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É Webhook."""
    try:
        asyncio.run(set_webhook_on_startup(application))
    except RuntimeError as e:
        # –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–æ–±—ã—Ç–∏–π
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å set_webhook —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ: {e}. –ü–æ–ø—Ä–æ–±—É–µ–º —Å –Ω–æ–≤—ã–º —Ü–∏–∫–ª–æ–º.")
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(set_webhook_on_startup(application))
            loop.close()
        except Exception as inner_e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Webhook: {inner_e}")

# –í—ã–ø–æ–ª–Ω—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Webhook –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if os.environ.get("WEBHOOK_URL"):
    run_once_set_webhook()
else:
    logger.warning("WEBHOOK_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. Webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Render.")


# –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Gunicorn (application - —ç—Ç–æ –æ–±—ä–µ–∫—Ç ASGI/WSGI)
# Gunicorn –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `application` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

# –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –∫–∞–∫ telegram_bot.py
# –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à Procfile_web —Å–æ–¥–µ—Ä–∂–∏—Ç:
# web: gunicorn telegram_bot:application --workers 1 --bind 0.0.0.0:$PORT
